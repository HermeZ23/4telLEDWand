<head>
  <link href="css/main.css" rel="stylesheet" type="text/css">
	<script src="lib/osc-browser.js"></script>
</head>

<body>
  <input type="file" id="files" name="files[]" multiple />
  <output id="list"></output>

  <script>
  var oscPort = new osc.WebSocketPort({
    url: "ws://localhost:8081",
    metadata: false
  });

  oscPort.open();

  oscPort.on('ready', function() {
    console.log('Ready');
  });

    function createElement(control) {
      switch (control.getNamedItem('type').value) {
        case 'push':
          createButton(control);
          break;
        case 'batteryh':
        case 'timeh':
          break;
        default:
          createOther(control);
      }
    }

    function createButton(control) {
      var ui_container = document.getElementById('generated-ui');
      var btn = document.createElement("button");
      var name = atob(control.getNamedItem('osc_cs').value);
      var name_node = document.createTextNode(name);
      btn.appendChild(name_node);
      btn.setAttribute('name', name);
      btn.setAttribute('value', control.getNamedItem('scalet').value);
      btn.style.top = 1080 - 360 - control.getNamedItem('x').value;
      btn.style.left = control.getNamedItem('y').value;
      btn.style.height = control.getNamedItem('w').value - 1;
      btn.style.width = control.getNamedItem('h').value -1;
      ui_container.appendChild(btn);

      btn.addEventListener('click', function(e) {
        oscPort.send({
          address: name	,
          args: [
            {
              type: "s",
              value: Number.parseInt(control.getNamedItem('scalet').value)
            }
          ]
        });
      })
    }

    function createOther(control) {
      var ui_container = document.getElementById('generated-ui');
      var btn = document.createElement("div");
      var name = atob((control.getNamedItem('text') || control.getNamedItem('osc_cs')).value);
      var name_node = document.createTextNode(name);
      btn.appendChild(name_node);
      btn.style.top = 1080 - 360 - control.getNamedItem('x').value;
      btn.style.left = control.getNamedItem('y').value;
      btn.style.heigth = control.getNamedItem('w').value;
      btn.style.width = control.getNamedItem('h').value;
      ui_container.appendChild(btn);
    }

    function handleFileSelect(evt) {
      var reader = new FileReader();
      reader.readAsText(evt.target.files[0]);

      reader.onload = function(e) {
        var txt = e.target.result;
        var parser = new DOMParser();
        var xmlDoc = parser.parseFromString(txt, "text/xml");

        var tabs = xmlDoc.getElementsByTagName("tabpage")

        window.controls = tabs[0].getElementsByTagName('control');
        controls = Array.prototype.slice.call(controls);

        var controls_data = controls.map(function(control) {
          return control.attributes;
        });

        controls_data.forEach(createElement)

        console.log(controls_data)
      }

    }

    document.getElementById('files').addEventListener('change', handleFileSelect, false);
  </script>
  <div id="generated-ui"></div>
</body>
