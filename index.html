<head>
  <link href="css/main.css" rel="stylesheet" type="text/css">
	<script src="lib/osc-browser.js"></script>
</head>

<body>
  <input type="file" id="files" name="files[]" multiple />
  <input type="checkbox" id="tablet"/>

  <script>
  var oscPort = new osc.WebSocketPort({
    url: "ws://localhost:8081",
    metadata: false
  });

  oscPort.open();

  oscPort.on('ready', function() {
    console.log('Ready');
  });

    function createElement(control) {
      var type = control.getNamedItem('type').value
      switch (type) {
        case 'push':
          return createButton(control);
        case 'batteryh':
        case 'batteryv':
        case 'timeh':
        case 'timev':
          break; // not implemented
        default:
          return createOther(control);
      }
    }

    function createButton(control) {
      var ui_container = document.getElementById('generated-ui');
      var tablet = document.getElementById('tablet').checked;
      var btn = document.createElement("button");

      var name = atob(control.getNamedItem('osc_cs').value);
      var x = control.getNamedItem('x').value;
      var y = control.getNamedItem('y').value;
      var w = control.getNamedItem('w').value;
      var h = control.getNamedItem('h').value;
      var scalet = control.getNamedItem('scalet').value;

      var name_node = document.createTextNode(name);
      btn.appendChild(name_node);
      btn.setAttribute('name', name);
      btn.setAttribute('value', scalet);
      btn.style.top = tablet ? 800 - x -w : y;
      btn.style.left = tablet ? y : x;
      btn.style.height = tablet ? w : h;
      btn.style.width = tablet ? h : w;

      btn.addEventListener('click', function(e) {
        oscPort.send({
          address: name	,
          args: [
            {
              type: "s",
              value: Number.parseInt(control.getNamedItem('scalet').value)
            }
          ]
        });
      });

      return btn;
    }

    function createOther(control) {
      var ui_container = document.getElementById('generated-ui');
      var btn = document.createElement("div");
      var tablet = document.getElementById('tablet').checked;

      var name = atob((control.getNamedItem('text') || control.getNamedItem('osc_cs')).value);
      var x = control.getNamedItem('x').value;
      var y = control.getNamedItem('y').value;
      var w = control.getNamedItem('w').value;
      var h = control.getNamedItem('h').value;
      var color = control.getNamedItem('color');

      var name_node = document.createTextNode(name);
      btn.appendChild(name_node);
      btn.style.top = tablet ? 800 - x -w: y;
      btn.style.left = tablet ? y : x;
      btn.style.heigth = tablet ? w : h;
      btn.style.width = tablet ? h : w;
      if (color)
        btn.style.color = color.value;

      return btn;
    }

    function createTab(tab, i) {
      var tab_container = document.createElement('div');
      var controls = tab.getElementsByTagName('control');
      controls = Array.prototype.slice.call(controls);

      var controls_data = controls.map(function(control) {
        return control.attributes;
      });

      tab_container.id = 'tab' + i;

      var control_nodes = controls_data.map(createElement).filter(Boolean);
      control_nodes.forEach(tab_container.appendChild.bind(tab_container));
      tab_container.className = 'tab-container';
      return tab_container;
    }

    function empty(node) {
      while (node.firstChild)
        node.removeChild(node.firstChild);
    }

    function createTabButton(_, i) {
      var btn = document.createElement('a');
      btn.className = 'tab';
      btn.href = '#tab' + i
      return btn;
    }

    /**
     * Read file as String, parse, create elements
     */
    function handleFileSelect(evt) {
      var reader = new FileReader();
      reader.readAsText(evt.target.files[0]);

      reader.onload = function(e) {
        var txt = e.target.result;
        var parser = new DOMParser();
        var xmlDoc = parser.parseFromString(txt, "text/xml");

        var ui_container = document.getElementById('generated-ui');
        empty(ui_container);

        var tabs = xmlDoc.getElementsByTagName("tabpage");
        tabs = Array.prototype.slice.call(tabs);

        var tab_containers = tabs.map(createTab).filter(Boolean);
        var tab_btns = tab_containers.map(createTabButton)
        var tab_bar = document.createElement('div');
        tab_bar.id = 'tab-bar';

        ui_container.appendChild(tab_bar);
        tab_containers.forEach(ui_container.appendChild.bind(ui_container));
        tab_btns.forEach(tab_bar.appendChild.bind(tab_bar));
      }

    }

    document.getElementById('files').addEventListener('change', handleFileSelect, false);
  </script>
  <div id="generated-ui"></div>
</body>
